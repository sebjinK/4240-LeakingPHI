<%- include('partials/header', { user: user }) %>
<style>
  .stack-wrapper { position: relative; min-height: 320px; overflow: hidden; }
  .stack-card {
    position: absolute;
    inset: 0;
    opacity: 0;
    transform: translateY(30px) scale(0.96);
    transition: opacity 0.35s ease, transform 0.35s ease;
    pointer-events: none;
  }
  .stack-card.active {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
    z-index: 3;
  }
  .stack-card.next {
    opacity: 0.6;
    transform: translateY(12px) scale(0.99);
    z-index: 2;
  }
  .stack-card.prev {
    opacity: 0.3;
    transform: translateY(-12px) scale(0.97);
    z-index: 1;
  }
  .stack-card.moving {
    transition: none !important;
  }
</style>

<% const suggestionList = (() => {
  if (typeof previousSuggestions !== 'undefined' && Array.isArray(previousSuggestions)) {
    return previousSuggestions;
  }
  if (typeof suggestions !== 'undefined' && Array.isArray(suggestions)) {
    return suggestions;
  }
  return [];
})(); %>

<div class="text-center mb-4">
  <h2><%= submitLabel %></h2>
  <p class="text-muted mb-0">Swipe through the cards to finish your entry.</p>
  <button class="btn btn-primary mt-3" type="button" data-bs-toggle="modal" data-bs-target="#entryModal">Open Entry Form</button>
  <a href="/entries" class="btn btn-outline-secondary ms-2 mt-3">Cancel</a>
</div>

<% const latestSuggestion = suggestionList.length ? suggestionList[0] : null; %>

<div class="modal fade" id="entryModal" tabindex="-1" aria-labelledby="entryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="entryModalLabel"><%= submitLabel %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="entryForm" action="<%= formAction %>" method="POST" novalidate>
          <% if (errors.length) { %>
            <div class="alert alert-danger">
              <ul class="mb-0">
                <% errors.forEach(e => { %>
                  <li><%= e.msg %></li>
                <% }) %>
              </ul>
            </div>
          <% } %>

          <div class="stack-wrapper">
            <div class="stack-container">
              <% let idx = 0; %>
              <% if (latestSuggestion) { %>
                <input type="hidden" name="suggestionFeedback" id="entrySuggestionFeedback">
                <div class="card border-0 shadow-sm stack-card" data-stack-card data-card-index="<%= idx++ %>" data-suggestion-card>
                  <div class="card-body">
                    <p class="text-uppercase text-secondary small mb-1">Latest AI suggestion</p>
                    <p class="fw-semibold mb-3"><%= latestSuggestion.suggestion || latestSuggestion %></p>
                    <input type="hidden" class="suggestion-id" value="<%= latestSuggestion.id || 0 %>">
                    <input type="hidden" class="suggestion-text" value="<%= latestSuggestion.suggestion || latestSuggestion %>">
                    <% if (latestSuggestion.rating) { %>
                      <p class="text-muted small mb-2">Previous rating: <%= latestSuggestion.rating %></p>
                    <% } %>
                    <div class="d-flex align-items-center">
                      <label class="form-label me-3 mb-0" for="rating-0">Your rating (1-10)</label>
                      <input
                        type="range"
                        class="form-range flex-grow-1 suggestion-rating"
                        min="1"
                        max="10"
                        value="<%= latestSuggestion.rating || 5 %>"
                        id="rating-0"
                      />
                      <span class="ms-2 text-muted small" data-rating-label>5/10</span>
                    </div>
                  </div>
                </div>
              <% } %>

              <div class="card shadow-sm border-0 stack-card" data-stack-card data-card-index="<%= idx++ %>">
                <div class="card-body">
                  <h6 class="text-uppercase text-secondary mb-3">Desired difficulty (1-10)</h6>
                  <select name="intensity" class="form-select">
                    <option value="">Select...</option>
                    <% for (let i = 1; i <= 10; i++) { %>
                      <option value="<%= i %>" <%= Number(entry.intensity) === i ? 'selected' : '' %>><%= i %></option>
                    <% } %>
                  </select>
                </div>
              </div>

              <div class="card shadow-sm border-0 stack-card" data-stack-card data-card-index="<%= idx++ %>">
                <div class="card-body">
                  <h6 class="text-uppercase text-secondary mb-3">Current activity level</h6>
                  <select name="activity_level" class="form-select">
                    <option value="">Select...</option>
                    <option value="sedentary" <%= entry.activity_level === 'sedentary' ? 'selected' : '' %>>Sedentary</option>
                    <option value="lightly_active" <%= entry.activity_level === 'lightly_active' ? 'selected' : '' %>>Lightly Active</option>
                    <option value="moderately_active" <%= entry.activity_level === 'moderately_active' ? 'selected' : '' %>>Moderately Active</option>
                    <option value="very_active" <%= entry.activity_level === 'very_active' ? 'selected' : '' %>>Very Active</option>
                  </select>
                </div>
              </div>

              <div class="card shadow-sm border-0 stack-card" data-stack-card data-card-index="<%= idx++ %>">
                <div class="card-body">
                  <h6 class="text-uppercase text-secondary mb-3">Exercise you enjoy most</h6>
                  <select name="exercise_enjoyment" class="form-select">
                    <option value="">Select...</option>
                    <option value="cardio" <%= entry.exercise_enjoyment === 'cardio' ? 'selected' : '' %>>Cardio</option>
                    <option value="strength" <%= entry.exercise_enjoyment === 'strength' ? 'selected' : '' %>>Strength</option>
                    <option value="flexibility" <%= entry.exercise_enjoyment === 'flexibility' ? 'selected' : '' %>>Flexibility</option>
                    <option value="mixed" <%= entry.exercise_enjoyment === 'mixed' ? 'selected' : '' %>>Mixed</option>
                    <option value="other" <%= entry.exercise_enjoyment === 'other' ? 'selected' : '' %>>Other</option>
                  </select>
                </div>
              </div>

              <div class="card shadow-sm border-0 stack-card" data-stack-card data-card-index="<%= idx++ %>">
                <div class="card-body">
                  <h6 class="text-uppercase text-secondary mb-3">Dietary preferences / restrictions</h6>
                  <input type="text" name="dietary_preferences" class="form-control" value="<%= entry.dietary_preferences || '' %>" placeholder="e.g., vegetarian, gluten-free">
                </div>
              </div>

              <div class="card shadow-sm border-0 stack-card" data-stack-card data-card-index="<%= idx++ %>">
                <div class="card-body">
                  <h6 class="text-uppercase text-secondary mb-3">Primary fitness goal</h6>
                  <input type="text" name="primary_goal" class="form-control" value="<%= entry.primary_goal || '' %>">
                </div>
              </div>

              <div class="card shadow-sm border-0 stack-card" data-stack-card data-card-index="<%= idx++ %>">
                <div class="card-body">
                  <h6 class="text-uppercase text-secondary mb-3">Short-term goals (next 1-3 months)</h6>
                  <textarea name="short_goal" class="form-control" rows="3"><%= entry.short_goal || '' %></textarea>
                </div>
              </div>

              <div class="card shadow-sm border-0 stack-card" data-stack-card data-card-index="<%= idx++ %>">
                <div class="card-body">
                  <h6 class="text-uppercase text-secondary mb-3">Long-term goals (6â€“12 months or more)</h6>
                  <textarea name="long_goal" class="form-control" rows="3"><%= entry.long_goal || '' %></textarea>
                </div>
              </div>

              <div class="card shadow-sm border-0 stack-card" data-stack-card data-card-index="<%= idx++ %>">
                <div class="card-body">
                  <h6 class="text-uppercase text-secondary mb-3">Days per week aiming to exercise</h6>
                  <input type="number" min="0" max="7" name="days_goal" class="form-control" value="<%= entry.days_goal || '' %>">
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-primary" id="stackPrev">Back</button>
              <button type="button" class="btn btn-primary" id="stackNext">Save & Next</button>
              <button class="btn btn-success" id="stackSubmit" type="submit">Save Entry</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const payloadInput = document.getElementById('entrySuggestionFeedback');
    const cards = Array.from(document.querySelectorAll('[data-stack-card]')).sort((a,b) => Number(a.dataset.cardIndex || 0) - Number(b.dataset.cardIndex || 0));
    let current = 0;
    let hammer;

    function updateCards() {
      cards.forEach((card, idx) => {
        card.classList.remove('active', 'next', 'prev');
        if (idx === current) card.classList.add('active');
        else if (idx === current + 1) card.classList.add('next');
        else if (idx === current - 1) card.classList.add('prev');
      });
      const nextBtn = document.getElementById('stackNext');
      const prevBtn = document.getElementById('stackPrev');
      if (cards.length) {
        prevBtn.disabled = current === 0;
        if (current === cards.length - 1) {
          nextBtn.disabled = true;
        } else {
          nextBtn.disabled = false;
        }
      }
      attachHammer();
    }

    const nextBtn = document.getElementById('stackNext');
    const prevBtn = document.getElementById('stackPrev');
    function goNext() {
      if (current < cards.length - 1) {
        current += 1;
        updateCards();
      }
    }
    function goPrev() {
      if (current > 0) {
        current -= 1;
        updateCards();
      }
    }
    if (nextBtn) nextBtn.addEventListener('click', goNext);
    if (prevBtn) prevBtn.addEventListener('click', goPrev);

    // Rating label + payload
    const suggestionCard = document.querySelector('[data-suggestion-card]');
    if (suggestionCard) {
      const range = suggestionCard.querySelector('.suggestion-rating');
      const label = suggestionCard.querySelector('[data-rating-label]');
      const updateLabel = () => { if (label && range) label.textContent = `${range.value}/10`; };
      if (range) {
        updateLabel();
        range.addEventListener('input', updateLabel);
      }
      const form = document.getElementById('entryForm');
      if (form && payloadInput) {
        form.addEventListener('submit', () => {
          const id = suggestionCard.querySelector('.suggestion-id')?.value || '';
          const text = suggestionCard.querySelector('.suggestion-text')?.value || '';
          const rating = range ? range.value : '';
          payloadInput.value = JSON.stringify([{ id, suggestion: text, rating }]);
        });
      }
    }

    function attachHammer() {
      if (!cards.length) return;
      if (hammer) { hammer.destroy(); hammer = null; }
      const active = cards[current];
      if (!active) return;
      hammer = new Hammer(active);
      hammer.get('pan').set({ direction: Hammer.DIRECTION_ALL });

      hammer.on('pan', ev => {
        active.classList.add('moving');
        const rotate = ev.deltaX / 20;
        active.style.transform = `translate(${ev.deltaX}px, ${ev.deltaY}px) rotate(${rotate}deg)`;
      });

      hammer.on('panend', ev => {
        active.classList.remove('moving');
        const threshold = 80;
        active.style.transform = '';
        if (Math.abs(ev.deltaX) > threshold) {
          if (ev.deltaX < 0) goNext();
          else goPrev();
        } else {
          updateCards();
        }
      });
    }

    updateCards();
  });
</script>

<%- include('partials/footer') %>
